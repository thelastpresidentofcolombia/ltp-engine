---
/**
 * Products Module - Fitness/Coaching Skin
 * 
 * ENGINE CONTRACT:
 * - Reads: operator.products (array of product objects)
 * - Skin defaults: fitnessDefaults.labels.products
 * 
 * Premium product cards with badges, bullets, and checkout links.
 * Glass aesthetic with featured card scaling.
 */

import { fitnessDefaults } from '../skin';

interface Props {
  operator: any;
  variant?: string;
}

const { operator } = Astro.props;

// === LABELS ===
const labels = operator.ui?.labels?.products ?? fitnessDefaults.labels.products;
const kicker = labels.kicker ?? 'Scalable Solutions';
const sectionTitle = labels.title ?? 'Programs & Products';
const subhead = labels.subhead ?? 'Templates, protocols, and full coaching programs built on proven systems.';
const detailsLabel = labels.detailsLabel ?? 'Details';
const checkoutPending = labels.checkoutPending ?? 'Coming soon!';

// === PRODUCTS ===
const products = operator.products ?? [];

// === CHECKOUT URL BUILDER ===
// Use the folder slug (not operator.id which may be different)
const slug = operator.slug ?? operator.meta?.slug ?? 'demo';
const vertical = operator.vertical ?? 'fitness';

function buildCheckoutUrl(productId: string): string {
  return `/api/checkout?slug=${slug}&vertical=${vertical}&product=${productId}`;
}

// Format price helper
function formatPrice(product: any): string {
  const price = product.priceUsd ?? product.price;
  if (!price) return 'Contact';
  const currency = operator.pricing?.currency ?? 'USD';
  return currency === 'USD' ? `$${price}` : `${price} ${currency}`;
}
---

<style>
  .glass-card {
    background: var(--color-glass-surface, rgba(255,255,255,0.03));
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid var(--color-glass-border, rgba(255,255,255,0.08));
  }
  .accent-hover {
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  .accent-hover:hover {
    border-color: color-mix(in srgb, var(--color-accent, #ccff00) 30%, transparent);
    box-shadow: 0 0 40px rgba(204,255,0,0.08);
  }
  .featured-card {
    border-color: color-mix(in srgb, var(--color-accent, #ccff00) 45%, transparent);
    box-shadow: 0 0 50px rgba(204,255,0,0.1);
  }
  .btn-primary {
    background: var(--color-accent, #ccff00);
    color: #000;
    font-weight: 700;
    transition: all 0.3s ease;
  }
  .btn-primary:hover {
    filter: brightness(1.1);
    box-shadow: 0 0 30px rgba(204,255,0,0.4);
  }
  .btn-ghost {
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    transition: all 0.3s ease;
  }
  .btn-ghost:hover {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.4);
  }
  .tag-pill {
    border: 1px solid color-mix(in srgb, var(--color-accent, #ccff00) 30%, transparent);
    background: color-mix(in srgb, var(--color-accent, #ccff00) 8%, transparent);
  }
</style>

<section id="products" class="py-20 md:py-28 px-4 md:px-6 border-y border-white/5 bg-[color-mix(in_srgb,var(--color-bg-surface,#080808)_92%,#000)] relative z-10">
  <div class="max-w-[1400px] mx-auto">
    
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6 md:gap-8 mb-10 md:mb-14" data-aos="fade-up">
      <div>
        <span 
          class="text-[10px] uppercase tracking-widest font-bold"
          style="color: var(--color-accent, #ccff00);"
        >
          {kicker}
        </span>
        <h2 class="font-[var(--font-display)] text-3xl md:text-5xl lg:text-6xl mt-3 text-white">
          {sectionTitle}
        </h2>
        <p class="text-[var(--color-text-secondary)] mt-3 max-w-2xl text-sm md:text-base">
          {subhead}
        </p>
      </div>
    </div>

    <!-- Products grid -->
    {products.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {products.map((product: any, index: number) => {
          const isFeatured = product.badge?.toLowerCase().includes('popular') || product.featured;
          return (
            <article 
              class:list={[
                "glass-card rounded-[var(--radius-2xl,24px)] p-6 md:p-8 relative overflow-hidden",
                isFeatured ? "featured-card md:scale-105" : "accent-hover"
              ]}
              data-aos="fade-up"
              data-aos-delay={index * 100}
            >
              {/* Featured badge */}
              {isFeatured && (
                <div 
                  class="absolute top-0 right-0 text-black text-[10px] font-bold px-4 py-1.5 rounded-bl-xl"
                  style="background: var(--color-accent, #ccff00);"
                >
                  {product.badge ?? 'MOST POPULAR'}
                </div>
              )}

              {/* Header with badge */}
              <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                  {product.badge && !isFeatured && (
                    <div class="inline-flex items-center gap-2 tag-pill px-3 py-1 rounded-full mb-3">
                      <span 
                        class="text-[10px] uppercase tracking-widest font-bold"
                        style="color: var(--color-accent, #ccff00);"
                      >
                        {product.badge}
                      </span>
                    </div>
                  )}
                  <h3 class="font-[var(--font-display)] text-xl md:text-2xl text-white">
                    {product.name}
                  </h3>
                  <p class="text-[var(--color-text-secondary)] text-sm mt-2">
                    {product.description}
                  </p>
                </div>
              </div>

              {/* Price */}
              <div class="mb-6">
                <p 
                  class="font-[var(--font-display)] text-3xl md:text-4xl"
                  style={isFeatured ? 'color: var(--color-accent, #ccff00);' : 'color: white;'}
                >
                  {formatPrice(product)}
                </p>
                {product.duration && (
                  <p class="text-[var(--color-text-muted)] text-xs mt-1">
                    {product.duration}
                  </p>
                )}
              </div>

              {/* Includes list */}
              {product.includes && product.includes.length > 0 && (
                <ul class="space-y-3 text-sm text-[var(--color-text-secondary)] border-t border-white/10 pt-6 mb-6">
                  {product.includes.slice(0, 5).map((item: string) => (
                    <li class="flex gap-3 items-start">
                      <span style="color: var(--color-accent, #ccff00);">âœ“</span>
                      <span>{item}</span>
                    </li>
                  ))}
                  {product.includes.length > 5 && (
                    <li class="text-[var(--color-text-muted)] text-xs">
                      +{product.includes.length - 5} more included
                    </li>
                  )}
                </ul>
              )}

              {/* CTAs */}
              <div class="flex gap-3">
                <a 
                  href={product.stripePriceId ? buildCheckoutUrl(product.id) : '#contact'}
                  class:list={[
                    "flex-1 text-center py-3.5 rounded-xl text-sm",
                    isFeatured ? "btn-primary" : "btn-ghost"
                  ]}
                >
                  {product.stripePriceId ? 'Get Access' : 'Apply'}
                </a>
                <button 
                  type="button"
                  class="btn-ghost px-4 py-3.5 rounded-xl text-sm"
                  data-product-details={product.id}
                >
                  {detailsLabel}
                </button>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      /* Placeholder */
      <div class="text-center text-[var(--color-text-muted)] py-12">
        <p>No products configured yet.</p>
      </div>
    )}
  </div>
</section>
