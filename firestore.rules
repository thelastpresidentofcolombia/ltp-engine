rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Portal conversations + messages ──
    // Read: authenticated users (onSnapshot for realtime messaging).
    // Write: server-only (API guard stack: resolveActor → requireFeature
    //        → requireOperatorAccess → requireRole).
    //
    // TODO (production hardening): Replace blanket auth read with:
    //   conversations: clientUid == auth.uid || coachUid == auth.uid
    //   messages: parent conversation participant check
    //   users/{uid}/*: auth.uid == uid
    match /conversations/{convId} {
      allow read: if request.auth != null;
      allow write: if false;

      match /messages/{msgId} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }

    // ── User data (profiles, sessions, entries, etc.) ──
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;

      match /{subcollection}/{docId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false;
      }
    }

    // ── Portal roles (elevated role lookups) ──
    match /portalRoles/{roleId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ── Public/read-only collections ──
    match /operators/{opId} {
      allow read: if true;
      allow write: if false;
    }

    // ── Default deny ──
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
