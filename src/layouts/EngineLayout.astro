---
/**
 * Engine Layout
 * 
 * The base HTML layout for all operator pages.
 * Handles:
 * - HTML structure with lang attribute
 * - Meta tags (SEO, OG, Twitter)
 * - Canonical URL
 * - Hreflang alternate links
 * - CSS variables injection (from vibe)
 * - Common scripts
 */

import type { SupportedLanguage, Operator } from '@/types/operator';
import type { HreflangLink } from '@config/seo';
import { seoConfig, buildOgImageUrl } from '@config/seo';
import { buildFaqJsonLd, serializeJsonLd } from '@/lib/seo/buildFaqJsonLd';

// Shared components
import WhatsAppFloat from '@/components/shared/WhatsAppFloat.astro';

// Global styles with Tailwind
import '@/styles/global.css';

interface Props {
  title: string;
  description: string;
  lang: SupportedLanguage;
  canonicalUrl: string;
  hreflangLinks?: HreflangLink[];
  operator?: Operator;
  ogImage?: string;
  noindex?: boolean;
}

const {
  title,
  description,
  lang,
  canonicalUrl,
  hreflangLinks = [],
  operator,
  ogImage,
  noindex = false,
} = Astro.props;

// Build full title with site name
const fullTitle = title.includes(seoConfig.siteName) 
  ? title 
  : `${title} | ${seoConfig.siteName}`;

// Determine OG image
const resolvedOgImage = ogImage 
  || operator?.seo.ogImage 
  || (operator ? buildOgImageUrl(operator.vertical, operator.id) : seoConfig.ogImage.defaultPath);

// Extract vibe tokens for CSS variable injection
const vibeTokens = operator?.vibe?.tokens ?? {};

// Build FAQPage JSON-LD (only if operator has sufficient FAQs)
// Supports both intel.faq and intel.faqs field names (JSON variation)
const operatorFaqs = operator?.intel?.faq ?? (operator?.intel as any)?.faqs ?? [];
const faqJsonLd = operatorFaqs.length > 0 
  ? buildFaqJsonLd({ faqs: operatorFaqs, minFaqCount: 3 })
  : null;
---

<!DOCTYPE html>
<html lang={lang} class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Primary Meta Tags -->
  <title>{fullTitle}</title>
  <meta name="title" content={fullTitle} />
  <meta name="description" content={description} />
  
  <!-- Robots -->
  {noindex ? (
    <meta name="robots" content="noindex, nofollow" />
  ) : (
    <meta name="robots" content="index, follow" />
  )}
  
  <!-- Canonical -->
  <link rel="canonical" href={canonicalUrl} />
  
  <!-- Hreflang -->
  {hreflangLinks.map((link) => (
    <link rel="alternate" hreflang={link.hreflang} href={link.href} />
  ))}
  <link rel="alternate" hreflang="x-default" href={canonicalUrl.replace(`/${lang}/`, '/en/')} />
  
  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalUrl} />
  <meta property="og:title" content={fullTitle} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={resolvedOgImage} />
  <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
  <meta property="og:site_name" content={seoConfig.siteName} />
  
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={canonicalUrl} />
  <meta name="twitter:title" content={fullTitle} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={resolvedOgImage} />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  
  <!-- Preconnect to external origins -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  
  <!-- Theme Variables from Operator Vibe -->
  <Fragment set:html={`<style>:root{--color-bg-base:${vibeTokens.bgBase ?? '#ffffff'};--color-bg-offset:${vibeTokens.bgOffset ?? '#f8f8f8'};--color-bg-surface:${vibeTokens.bgSurface ?? '#fafafa'};--color-bg-inverse:${vibeTokens.bgInverse ?? '#0a0a0a'};--color-text-primary:${vibeTokens.textMain ?? '#0a0a0a'};--color-text-secondary:${vibeTokens.textSecondary ?? '#525252'};--color-text-muted:${vibeTokens.textMuted ?? '#8a8a8a'};--color-text-inverse:${vibeTokens.textInverse ?? '#ffffff'};--color-border:${vibeTokens.borderLine ?? '#e5e5e5'};--color-border-strong:${vibeTokens.borderStrong ?? '#d4d4d4'};--color-accent:${vibeTokens.accent ?? '#1e3a5f'};--color-accent-hover:${vibeTokens.accentHover ?? '#2d4a6f'};--color-hover-bg:${vibeTokens.hoverBg ?? '#f5f5f5'};--color-success:${vibeTokens.success ?? '#059669'};--color-error:${vibeTokens.error ?? '#dc2626'}}</style>`} />
  
  <!-- Base Styles -->
  <style is:global>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    
    * {
      margin: 0;
    }
    
    html {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }
    
    body {
      font-family: var(--font-body);
      background-color: var(--color-bg-base);
      color: var(--color-text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    img, picture, video, canvas, svg {
      display: block;
      max-width: 100%;
    }
    
    input, button, textarea, select {
      font: inherit;
    }
    
    p, h1, h2, h3, h4, h5, h6 {
      overflow-wrap: break-word;
    }
    
    a {
      color: inherit;
      text-decoration: none;
    }
    
    /* Focus visible for accessibility */
    :focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }
    
    /* Selection */
    ::selection {
      background-color: var(--color-accent);
      color: white;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--color-bg-surface);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--color-text-muted);
    }
  </style>
  
  <!-- Slot for additional head content -->
  <slot name="head" />
</head>
<body>
  <!-- Skip to main content for accessibility -->
  <a 
    href="#main-content" 
    class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent focus:text-white focus:rounded"
  >
    {lang === 'es' ? 'Saltar al contenido' : 'Skip to content'}
  </a>
  
  <!-- Main Content -->
  <main id="main-content">
    <slot />
  </main>
  
  <!-- Structured Data: LocalBusiness -->
  {operator && (
    <script type="application/ld+json" set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'LocalBusiness',
      name: operator.brand.name,
      description: operator.seo.description,
      url: canonicalUrl,
      image: operator.media.heroImage,
      address: {
        '@type': 'PostalAddress',
        addressLocality: operator.location.cityName,
        addressCountry: operator.location.country,
      },
      contactPoint: {
        '@type': 'ContactPoint',
        email: operator.contact.email,
        telephone: operator.contact.whatsapp || operator.contact.phone,
      },
    })} />
  )}
  
  <!-- Structured Data: FAQPage (if operator has â‰¥3 valid FAQs) -->
  {faqJsonLd && (
    <script type="application/ld+json" set:html={serializeJsonLd(faqJsonLd)} />
  )}
  
  <!-- WhatsApp Floating Button (if operator has WhatsApp) -->
  {operator?.contact?.whatsapp && (
    <WhatsAppFloat whatsappNumber={operator.contact.whatsapp} />
  )}
  
  <!-- Screen reader only utility -->
  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</body>
</html>
