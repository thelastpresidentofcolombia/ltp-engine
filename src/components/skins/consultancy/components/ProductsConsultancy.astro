---
/**
 * Products Module - Consultancy Skin
 * 
 * ENGINE CONTRACT:
 * - Reads: operator.products, operator.tools, operator.ui.labels.products
 * - Skin defaults: consultancyDefaults.labels.products
 * 
 * TOKEN DEPENDENCIES:
 * - --color-bg-base, --color-bg-offset, --color-bg-inverse
 * - --color-text-primary, --color-text-secondary, --color-text-muted
 * - --color-border, --color-border-strong
 * 
 * VISUAL METAPHOR: Digital Infrastructure / Installable Systems
 * Premium card grid with Swiss precision.
 */

import { consultancyDefaults } from '../skin';

interface Props {
  operator: any;
  variant?: string;
}

const { operator } = Astro.props;

const products: any[] = operator.products ?? [];

// Tools might be in a separate array or embedded in products
const tools: any[] = 
  operator.tools ?? 
  products.filter((p: any) => p.type === 'tool' || p.category === 'tool');

// Filter out tools from main products list if they're mixed in
const coreProducts = products.filter((p: any) => p.type !== 'tool' && p.category !== 'tool');

// === LABELS (operator.ui.labels.products → skin defaults) ===
const productsLabel = operator.ui?.labels?.products?.section ?? consultancyDefaults.labels.products.section;
const productsTitle = operator.ui?.labels?.products?.title ?? consultancyDefaults.labels.products.title;
const toolsLabel = operator.ui?.labels?.products?.toolsSection ?? consultancyDefaults.labels.products.toolsSection;
const toolsTitle = operator.ui?.labels?.products?.tools ?? consultancyDefaults.labels.products.tools;
---

<!-- DIGITAL PRODUCTS SECTION -->
<section id="products" class="py-2 bg-[var(--color-bg-offset)]">
  <div class="max-w-[1100px] mx-auto px-4 lg:px-10">
    <div class="mb-2">
      <p class="font-mono text-[9px] uppercase tracking-[0.12em] text-[var(--color-text-muted)] mb-2">
        {productsLabel}
      </p>
      <h2 class="text-2xl md:text-3xl font-black tracking-tight text-[var(--color-text-primary)]">
        {productsTitle}
      </h2>
    </div>

    {coreProducts.length > 0 ? (
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-0 border border-[var(--color-border)] bg-[var(--color-bg-base)]">
        {coreProducts.map((product: any, index: number) => (
          <div 
            class:list={[
              'p-6 lg:p-8 flex flex-col relative group',
              'hover:bg-[var(--color-bg-offset)] transition-colors duration-300',
              index % 3 !== 2 ? 'lg:border-r border-[var(--color-border)]' : '',
              index < coreProducts.length - 3 ? 'border-b lg:border-b-0' : '',
              index < coreProducts.length - (coreProducts.length % 3 || 3) ? 'lg:border-b border-[var(--color-border)]' : '',
            ]}
          >
            {/* Top accent line on hover */}
            <div class="absolute top-0 left-0 w-full h-0.5 bg-[var(--color-bg-inverse)] scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left"></div>
            
            {product.badge && (
              <p class="font-mono text-[9px] uppercase tracking-[0.12em] text-[var(--color-text-muted)] mb-2">
                {product.badge}
              </p>
            )}
            
            <h3 class="text-lg lg:text-xl font-bold mb-3 tracking-tight text-[var(--color-text-primary)]">{product.name}</h3>
            
            {product.outcome && (
              <p class="text-[var(--color-text-secondary)] text-sm leading-relaxed mb-4">{product.outcome}</p>
            )}
            
            {product.includes && product.includes.length > 0 && (
              <ul class="text-[10px] text-[var(--color-text-muted)] space-y-2 font-mono border-t border-[var(--color-border)] pt-4 mb-6 flex-grow">
                {product.includes.slice(0, 5).map((item: string) => (
                  <li class="flex items-start gap-2">
                    <span class="text-[var(--color-border-strong)] mt-0.5">—</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            )}
            
            <div class="mt-auto flex items-end justify-between">
              {product.priceUsd && (
                <div>
                  <span class="text-2xl font-black tracking-tight text-[var(--color-text-primary)]">${product.priceUsd.toLocaleString()}</span>
                  <span class="text-[var(--color-text-muted)] text-xs ml-1">USD</span>
                </div>
              )}
              <a 
                href="#conversion"
                class="font-mono text-[9px] uppercase tracking-[0.12em] text-[var(--color-text-muted)] hover:text-[var(--color-text-primary)] transition-colors flex items-center gap-1"
              >
                Details
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <div class="border border-[var(--color-border)] p-10 bg-[var(--color-bg-base)] text-[var(--color-text-muted)]">
        Add products in <code class="font-mono bg-[var(--color-bg-offset)] px-1.5 py-0.5 text-xs">products[]</code> array.
      </div>
    )}
  </div>
</section>

<!-- FREE TOOLS SECTION - Only renders if tools exist -->
{tools.length > 0 && (
  <section id="tools" class="py-2">
    <div class="max-w-[1000px] mx-auto px-4 lg:px-10">
      <div class="mb-2">
        <p class="font-mono text-[9px] uppercase tracking-[0.12em] text-[var(--color-text-muted)] mb-2">
          {toolsLabel}
        </p>
        <h2 class="text-xl md:text-2xl font-bold tracking-tight text-[var(--color-text-primary)]">{toolsTitle}</h2>
      </div>
      
      <div class="grid md:grid-cols-2 gap-3">
        {tools.map((tool: any) => (
          <a 
            href={tool.href ?? '#conversion'}
            class="group block border border-[var(--color-border)] p-8 lg:p-10 hover:border-[var(--color-bg-inverse)] transition-all duration-300 relative overflow-hidden bg-[var(--color-bg-base)]"
          >
            <div class="absolute top-0 left-0 w-1 h-full bg-[var(--color-bg-inverse)] scale-y-0 group-hover:scale-y-100 transition-transform duration-300 origin-top"></div>
            
            <div class="flex items-start justify-between gap-4">
              <div>
                <h4 class="font-bold text-lg mb-2 text-[var(--color-text-primary)] group-hover:text-[var(--color-text-secondary)] transition-colors">
                  {tool.name ?? tool.title}
                </h4>
                {tool.description && (
                  <p class="text-[var(--color-text-secondary)] text-[15px] leading-relaxed">{tool.description}</p>
                )}
              </div>
              <svg class="w-5 h-5 text-[var(--color-border-strong)] group-hover:text-[var(--color-text-primary)] group-hover:translate-x-1 transition-all flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
)}
