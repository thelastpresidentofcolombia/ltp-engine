---
/**
 * Portal Layout — Shared Shell for All Portal Pages
 * 
 * ENGINE CONTRACT:
 * - Provides the HTML skeleton for every /portal/* page.
 * - Sidebar nav is rendered server-side from static feature config.
 * - Client scripts hydrate auth + data into #portal-content.
 * - Uses engine CSS variables (vibe tokens) — defaults to a neutral dark theme
 *   since portal is cross-operator (not tied to a single operator's brand).
 * - Responsive: sidebar collapses to bottom tab bar on mobile.
 */

import '@/styles/global.css';
import '@/styles/portal-system.css';
import { getIcon } from '@/lib/ui/icons';
import { ClientRouter, fade } from 'astro:transitions';

interface Props {
  title: string;
  description?: string;
  activeSection?: string;
  operatorId: string;
}

const {
  title,
  description = 'Your client portal — manage programs, sessions, and more.',
  activeSection = 'dashboard',
  operatorId,
} = Astro.props;

const portalBase = `/portal/${operatorId}`;

/**
 * Static nav items. The client script will hide items not in the
 * operator's resolved feature set and inject badge counts.
 * We render all to avoid layout shift — hidden via CSS class `[data-hidden]`.
 */
const navItems = [
  { id: 'dashboard', label: 'Dashboard', href: `${portalBase}/dashboard`, icon: 'grid' },
  { id: 'sessions',  label: 'Sessions',  href: `${portalBase}/sessions`,  icon: 'calendar' },
  { id: 'programs',  label: 'Programs',  href: `${portalBase}/programs`,  icon: 'package' },
  { id: 'entries',   label: 'Updates',   href: `${portalBase}/entries`,   icon: 'file-text' },
  { id: 'timeline',  label: 'Timeline',  href: `${portalBase}/timeline`,  icon: 'chart' },
  { id: 'messaging', label: 'Messages',  href: `${portalBase}/messages`,  icon: 'message' },
  { id: 'goals',     label: 'Goals',     href: `${portalBase}/goals`,     icon: 'target' },
  { id: 'reports',   label: 'Reports',   href: `${portalBase}/reports`,   icon: 'clipboard' },
  { id: 'profile',   label: 'Profile',   href: `${portalBase}/profile`,   icon: 'user' },
];
---

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{title} | Portal</title>
  <meta name="description" content={description} />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" id="meta-theme-color" content="#6366f1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <ClientRouter />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

  <!-- Portal-specific CSS vars (neutral dark theme) -->
  <style is:global>
    :root {
      /* ── Surfaces ── */
      --portal-bg: #0d0d12;
      --portal-bg-card: #14141d;
      --portal-surface: #1a1a2e;
      --portal-bg-hover: #1e1e28;

      /* ── Borders ── */
      --portal-border: rgba(255,255,255,0.06);
      --portal-border-strong: rgba(255,255,255,0.12);

      /* ── Typography ── */
      --portal-text: #ececf1;
      --portal-text-secondary: #9da0b0;
      --portal-text-muted: #6b7280;

      /* ── Brand ── */
      --portal-accent: #6366f1;
      --portal-accent-hover: #818cf8;

      /* ── Semantic ── */
      --portal-success: #10b981;
      --portal-error: #ef4444;
      --portal-warning: #f59e0b;

      /* ── Radii ── */
      --portal-radius: 14px;
      --portal-radius-sm: 8px;

      /* ── Layout ── */
      --portal-sidebar-width: 250px;
      --portal-font: 'Inter', system-ui, -apple-system, sans-serif;

      /* ── Motion ── */
      --portal-transition: 150ms ease-out;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; }

    html {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: var(--portal-font);
      background: var(--portal-bg);
      color: var(--portal-text);
      line-height: 1.5;
      min-height: 100vh;
      display: flex; /* Prevent layout shift on load */
      flex-direction: column;
    }

    /* ========================================
       PORTAL SHELL LAYOUT
       ======================================== */
    .portal-shell {
      display: flex;
      min-height: 100vh;
    }

    /* ---------- SIDEBAR (desktop) ---------- */
    .portal-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: var(--portal-sidebar-width);
      background: var(--portal-bg-card);
      border-right: 1px solid var(--portal-border);
      display: flex;
      flex-direction: column;
      z-index: 40;
      overflow-y: auto;
    }

    .sidebar-brand {
      padding: 24px 20px 16px;
      border-bottom: 1px solid var(--portal-border);
    }
    .sidebar-brand-name {
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--portal-text-muted);
    }
    .sidebar-brand-logo {
      margin-top: 8px;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--portal-text);
    }
    .sidebar-brand-logo img {
      max-height: 32px;
      width: auto;
      object-fit: contain;
    }
    .sidebar-brand-tagline {
      font-size: 0.75rem;
      color: var(--portal-text-muted);
      margin-top: 4px;
      line-height: 1.3;
    }
    .sidebar-brand-tagline:empty { display: none; }

    .login-brand {
      text-align: center;
      margin-bottom: 20px;
    }
    .login-brand:empty { display: none; }
    .login-brand-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--portal-text);
    }
    .login-brand-tagline {
      font-size: 0.8rem;
      color: var(--portal-text-muted);
      margin-top: 4px;
    }
    .login-brand img {
      max-height: 40px;
      width: auto;
      margin: 0 auto 8px;
      display: block;
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: var(--portal-radius-sm);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--portal-text-secondary);
      text-decoration: none;
      transition: all var(--portal-transition);
      position: relative;
    }
    .nav-item:hover {
      background: var(--portal-bg-hover);
      color: var(--portal-text);
    }
    .nav-item:focus-visible {
      outline: 2px solid var(--portal-accent);
      outline-offset: -2px;
    }
    .nav-item[data-active="true"] {
      background: rgba(99, 102, 241, 0.12);
      color: var(--portal-accent);
    }
    .nav-item[data-hidden="true"] {
      display: none;
    }
    .nav-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: inherit;
    }
    .nav-icon svg { width: 18px; height: 18px; stroke-width: 2.2px; }
    .nav-label { flex: 1; }
    .nav-badge {
      background: var(--portal-accent);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 1px 7px;
      border-radius: 99px;
      min-width: 20px;
      text-align: center;
    }
    .nav-badge:empty, .nav-badge[data-count="0"] { display: none; }

    .sidebar-footer {
      padding: 12px 8px;
      border-top: 1px solid var(--portal-border);
    }

    .sidebar-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: var(--portal-radius-sm);
      cursor: default;
    }
    .sidebar-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--portal-accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .sidebar-user-email {
      font-size: 0.8rem;
      color: var(--portal-text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 150px;
    }
    .sidebar-logout {
      display: block;
      width: 100%;
      margin-top: 4px;
      padding: 8px 14px;
      border: none;
      border-radius: var(--portal-radius-sm);
      background: transparent;
      color: var(--portal-text-muted);
      font-size: 0.8rem;
      cursor: pointer;
      text-align: left;
      transition: all var(--portal-transition);
    }
    .sidebar-logout:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--portal-error);
    }
    .sidebar-logout:focus-visible {
      outline: 2px solid var(--portal-accent);
      outline-offset: -2px;
    }

    /* ---------- MAIN CONTENT ---------- */
    .portal-main {
      flex: 1;
      margin-left: var(--portal-sidebar-width);
      padding: 32px 40px;
      min-width: 0; /* prevent flex overflow */
    }
    .portal-main > #portal-content {
      max-width: 920px;
      width: 100%;
      margin: 0 auto;
    }

    .portal-page-header {
      margin-bottom: 28px;
    }
    .portal-page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--portal-text);
      margin-bottom: 4px;
    }
    .portal-page-subtitle,
    .portal-page-desc {
      font-size: 0.95rem;
      color: var(--portal-text-secondary);
      margin-top: 2px;
    }

    /* ---------- LOGIN SCREEN ---------- */
    .portal-login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
    }
    .portal-login-card {
      background: var(--portal-bg-card);
      border: 1px solid var(--portal-border);
      border-radius: var(--portal-radius);
      padding: 40px;
      max-width: 420px;
      width: 100%;
    }
    .portal-login-card h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .portal-login-card p {
      color: var(--portal-text-secondary);
      margin-bottom: 24px;
      font-size: 0.95rem;
    }
    .portal-login-card input[type="email"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--portal-border-strong);
      border-radius: var(--portal-radius-sm);
      background: var(--portal-bg);
      color: var(--portal-text);
      font-size: 1rem;
      margin-bottom: 12px;
      outline: none;
      transition: border-color var(--portal-transition),
                  box-shadow var(--portal-transition);
    }
    .portal-login-card input[type="email"]:focus {
      border-color: var(--portal-accent);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }
    .portal-login-card .btn-primary {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: var(--portal-radius-sm);
      background: var(--portal-accent);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background var(--portal-transition);
    }
    .portal-login-card .btn-primary:hover {
      background: var(--portal-accent-hover, var(--portal-accent));
    }
    .portal-login-card .btn-primary:active {
      transform: scale(0.97);
    }
    .portal-login-card .btn-primary:focus-visible {
      outline: 2px solid var(--portal-accent);
      outline-offset: 2px;
    }
    .portal-login-card .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .portal-login-error {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: var(--portal-radius-sm);
      padding: 10px 14px;
      color: var(--portal-error);
      font-size: 0.85rem;
      margin-top: 12px;
      display: none;
    }
    .portal-login-success {
      background: rgba(16,185,129,0.1);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: var(--portal-radius-sm);
      padding: 16px;
      text-align: center;
      margin-top: 16px;
    }
    .portal-login-success h3 {
      color: var(--portal-success);
      font-size: 1.1rem;
      margin-bottom: 4px;
    }

    /* ---------- SHARED COMPONENTS ---------- */
    .card {
      background: var(--portal-bg-card);
      border: 1px solid var(--portal-border);
      border-radius: var(--portal-radius);
      padding: 24px;
      transition: border-color var(--portal-transition);
    }
    .card:hover {
      border-color: var(--portal-border-strong);
    }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .stat-card {
      background: var(--portal-bg-card);
      border: 1px solid var(--portal-border);
      border-radius: var(--portal-radius);
      padding: 20px 24px;
    }
    .stat-label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--portal-text-muted);
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--portal-text);
    }
    .stat-sub {
      font-size: 0.8rem;
      color: var(--portal-text-secondary);
      margin-top: 2px;
    }

    /* Skeleton loader */
    .skeleton {
      background: linear-gradient(90deg, var(--portal-bg-hover) 25%, var(--portal-bg-card) 50%, var(--portal-bg-hover) 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.5s ease-in-out infinite;
      border-radius: var(--portal-radius-sm);
    }
    @keyframes skeleton-shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* empty-state → portal-system.css */

    /* ---------- MOBILE: bottom tab bar ---------- */
    @media (max-width: 768px) {
      .portal-sidebar {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        height: auto;
        flex-direction: column;
        border-right: none;
        border-top: 1px solid var(--portal-border);
        padding-bottom: env(safe-area-inset-bottom, 0px);
        z-index: 100;
      }
      .sidebar-brand, .sidebar-footer { display: none; }
      .sidebar-nav {
        flex-direction: row;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding: 6px 4px;
        gap: 0;
        justify-content: space-around;
      }
      .sidebar-nav::-webkit-scrollbar { display: none; }
      .nav-item {
        flex-direction: column;
        gap: 2px;
        padding: 6px 8px;
        font-size: 0.65rem;
        min-width: 56px;
        text-align: center;
      }
      .nav-icon { font-size: 1.2rem; }
      .nav-badge {
        position: absolute;
        top: 2px;
        right: 4px;
        font-size: 0.6rem;
        padding: 0 5px;
      }
      .portal-main {
        margin-left: 0;
        /* Clear bottom tab bar + safe area */
        padding: 16px 12px calc(72px + env(safe-area-inset-bottom, 0px));
      }
      .portal-main > #portal-content {
        max-width: 100%;
        overflow-x: clip;
      }
      .portal-login-card {
        padding: 28px 24px;
      }
      .nav-item {
        min-height: 44px;
        justify-content: center;
      }
      .portal-page-header {
        margin-bottom: 20px;
      }
      .portal-page-title {
        font-size: 1.4rem;
      }
    }

    /* ---------- SMALL MOBILE: compact tab labels ---------- */
    @media (max-width: 480px) {
      .nav-item {
        min-width: 48px;
        padding: 4px 4px;
        font-size: 0.58rem;
      }
      .nav-icon { font-size: 1.05rem; }
      .portal-main {
        padding: 12px 8px calc(68px + env(safe-area-inset-bottom, 0px));
      }
      .portal-page-title {
        font-size: 1.25rem;
      }
      .portal-page-subtitle {
        font-size: 0.8rem;
      }
    }
  </style>

  <slot name="head" />
</head>
<body>
  <!-- Auth gate: shown before login -->
  <div id="portal-login" class="portal-login-screen" style="display: none;" transition:animate="none">
    <div class="portal-login-card">
      <div id="login-brand" class="login-brand"></div>
      <h2>Welcome Back</h2>
      <p>Get a magic link sent to your email — no password needed.</p>
      <input id="login-email" type="email" placeholder="you@email.com" />
      <button id="login-send" class="btn-primary">Send login link</button>
      <div id="login-error" class="portal-login-error"></div>
    </div>
  </div>

  <!-- Authenticated shell: shown after login -->
  <div id="portal-shell" class="portal-shell" style="display: none;">
    <!-- Sidebar -->
    <aside class="portal-sidebar" transition:persist>
      <div class="sidebar-brand">
        <div class="sidebar-brand-name">Portal</div>
        <div id="sidebar-brand-logo" class="sidebar-brand-logo"></div>
        <div id="sidebar-brand-tagline" class="sidebar-brand-tagline"></div>
      </div>

      <nav class="sidebar-nav" id="sidebar-nav">
        {navItems.map(item => (
          <a
            href={item.href}
            class="nav-item"
            data-nav-id={item.id}
            data-active={item.id === activeSection ? 'true' : 'false'}
          >
            <span class="nav-icon" set:html={getIcon(item.icon as any)} />
            <span class="nav-label">{item.label}</span>
            <span class="nav-badge" data-badge-id={item.id} data-count="0"></span>
          </a>
        ))}
      </nav>

      <!-- Instant shell: show portal immediately from sessionStorage cache (no auth wait) -->
      <script is:inline>
      (function(){
        try {
          var r = sessionStorage.getItem('ltp_portal_bootstrap');
          if (!r) return;
          var c = JSON.parse(r);
          if (!c.data) return;
          var d = c.data;

          // Show shell instantly — skip the 500ms-2s Firebase auth wait
          var shell = document.getElementById('portal-shell');
          var login = document.getElementById('portal-login');
          if (shell) shell.style.display = '';
          if (login) login.style.display = 'none';

          // Apply cached branding
          var ops = d.operators || {};
          var opIds = Object.keys(ops);
          if (opIds.length > 0) {
            var p = ops[opIds[0]];
            if (p && p.accentColor) {
              document.documentElement.style.setProperty('--portal-accent', p.accentColor);
            }
            var brandEl = document.querySelector('.sidebar-brand-name');
            if (brandEl && p && p.brandName) brandEl.textContent = p.brandName;
          }

          // Apply cached user info
          if (d.actor && d.actor.email) {
            var emailEl = document.getElementById('sidebar-email');
            if (emailEl) emailEl.textContent = d.actor.email;
            var avatarEl = document.getElementById('sidebar-avatar');
            if (avatarEl) avatarEl.textContent = d.actor.email.split('@')[0].substring(0,2).toUpperCase();
          }

          // Hide features not in resolved list
          var f = d.features || [];
          document.querySelectorAll('.nav-item[data-nav-id]').forEach(function(el) {
            var id = el.getAttribute('data-nav-id');
            if (id && f.indexOf(id) === -1) el.setAttribute('data-hidden', 'true');
          });

          // Detect OS for keyboard shortcut hint (⌘K on Mac, Ctrl+K on Windows/Linux)
          var isMac = /Mac|iPod|iPhone|iPad/.test(navigator.platform || '');
          var kbdEl = document.getElementById('cmd-k-kbd');
          if (kbdEl && !isMac) kbdEl.textContent = 'Ctrl K';
        } catch(e) {}
      })();
      </script>

      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div id="sidebar-avatar" class="sidebar-user-avatar"></div>
          <div id="sidebar-email" class="sidebar-user-email"></div>
        </div>
        <button id="sidebar-logout" class="sidebar-logout">Sign out</button>
        <button id="sidebar-cmd-k" class="sidebar-cmd-hint" type="button" aria-label="Open command palette">
          <span class="sidebar-cmd-hint-icon" set:html={getIcon('search' as any)} />
          <span>Search…</span>
          <kbd id="cmd-k-kbd" class="cp-kbd">⌘K</kbd>
        </button>
      </div>
    </aside>

    <!-- Page content -->
    <div class="portal-main" transition:animate={fade({ duration: '0.15s' })}>
      <div id="portal-content">
        <!-- Skeleton: auto-removed once initPortal() resolves -->
        <div id="portal-skeleton">
          <div class="portal-page-header">
            <div class="skeleton" style="width: 180px; height: 28px; margin-bottom: 8px;"></div>
            <div class="skeleton" style="width: 280px; height: 16px;"></div>
          </div>
          <div class="skeleton-grid-3" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:16px; margin-bottom:24px;">
            <div class="skeleton" style="height: 90px; border-radius:var(--portal-radius);"></div>
            <div class="skeleton" style="height: 90px; border-radius:var(--portal-radius);"></div>
            <div class="skeleton" style="height: 90px; border-radius:var(--portal-radius);"></div>
          </div>
          <div class="skeleton" style="height: 200px; border-radius:var(--portal-radius); margin-bottom:16px;"></div>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:16px;">
            <div class="skeleton" style="height: 140px; border-radius:var(--portal-radius);"></div>
            <div class="skeleton" style="height: 140px; border-radius:var(--portal-radius);"></div>
          </div>
        </div>

        <!-- Page-specific content (from each portal page's slot) -->
        <slot />
      </div>
    </div>
  </div>

  <!-- View transition lifecycle: preserves shell state + instant nav active state -->
  <script>
    // ── Global Firestore cleanup on every navigation ──
    // Uses window bridge — does NOT import messaging.client.ts, so Firebase
    // Firestore SDK is only loaded when the user actually visits Messages.
    document.addEventListener('astro:before-swap', () => {
      (window as any).__cleanupFirestoreListeners?.();
    });

    // ── Preserve shell visibility during view transitions ──
    // Without this, the new page's portal-shell starts display:none
    document.addEventListener('astro:before-swap', (ev: any) => {
      const oldShell = document.getElementById('portal-shell');
      const oldLogin = document.getElementById('portal-login');
      if (oldShell) {
        const newShell = ev.newDocument.getElementById('portal-shell');
        if (newShell) newShell.style.display = oldShell.style.display;
      }
      if (oldLogin) {
        const newLogin = ev.newDocument.getElementById('portal-login');
        if (newLogin) newLogin.style.display = oldLogin.style.display;
      }
    });

    // ── Update persisted sidebar active state after navigation ──
    // The sidebar persists (transition:persist) so server-rendered
    // data-active from the new page is discarded. Fix it here.
    // URL pattern: /portal/{operatorId}/{page}
    document.addEventListener('astro:after-swap', () => {
      const path = window.location.pathname;
      // Extract page slug from operator-scoped URL: /portal/{opId}/{page} → {page}
      const pageSlug = path.match(/^\/portal\/[^/]+\/([^/?#]+)/)?.[1] || 'dashboard';
      document.querySelectorAll('.nav-item[data-nav-id]').forEach(item => {
        const href = item.getAttribute('href') || '';
        const navSlug = href.match(/^\/portal\/[^/]+\/([^/?#]+)/)?.[1] || '';
        item.setAttribute('data-active', navSlug === pageSlug ? 'true' : 'false');
      });
    });

    // ── Instant active state on nav click (before transition starts) ──
    document.addEventListener('click', (e) => {
      const item = (e.target as HTMLElement)?.closest('.nav-item[data-nav-id]');
      if (!item) return;
      document.querySelectorAll('.nav-item[data-nav-id]').forEach(i =>
        i.setAttribute('data-active', 'false')
      );
      item.setAttribute('data-active', 'true');
    });

    // ── Command palette: init after bootstrap + update on navigation ──
    import { initCommandPalette, updatePaletteContext, togglePalette } from '../lib/portal/commandPalette.client';
    import { getBootstrap } from '../lib/portal/portalAuth.client';
    import { getActiveOperatorId } from '../lib/portal/portalNav';

    // Try to init palette from cached bootstrap (instant on SPA transitions)
    function tryInitPalette() {
      const data = getBootstrap();
      if (data) {
        // Resolve active operator from URL, not opIds[0]
        const opIds = Object.keys(data.operators);
        const urlOpId = getActiveOperatorId();
        const activeOpId = (urlOpId && opIds.includes(urlOpId)) ? urlOpId : opIds[0];
        const primaryPortal = activeOpId ? data.operators[activeOpId]?.portal : null;
        const cmdConfig = (primaryPortal as any)?.commands;
        initCommandPalette(data, cmdConfig);
      }
    }

    // Init on first load
    tryInitPalette();

    // Re-init after bootstrap resolves (covers cold start)
    document.addEventListener('portal:bootstrapped', () => tryInitPalette());

    // Update palette context on view transitions (current page changes)
    document.addEventListener('astro:after-swap', () => {
      updatePaletteContext(window.location.pathname);
    });

    // Sidebar hint button opens palette
    document.getElementById('sidebar-cmd-k')?.addEventListener('click', () => {
      togglePalette();
    });
  </script>
</body>
</html>
